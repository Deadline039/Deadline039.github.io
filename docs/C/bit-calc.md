# 位运算

# 位运算与写入

> C大师 011, 055-063

在嵌入式和算法中，位运算符非常常见。一般寄存器都是以bit为单位来操作的。因此，掌握位运算的方法，非常重要。至于位运算符什么原理，怎么用，看上面的视频。下面总结一下：

- 读取位用「与」
- 位置0用「与」`&=`，置1用「或」`|=`
- 位取反用「异或」`^=`
- 操作某个位用移位操作，例如操作`bit3`: `(1U << 3)`

下面举个例子：

``` C
#include <stdint.h>
#include <stdio.h>

/**
 * 状态寄存器
 * bit[31:16] 保留
 * bit[15] TXNE(R)   发送为空
 * bit[14] BASY(RW)  是否被占用
 * bit[8:0] DATA(RW) 数据
 */
uint32_t status_reg = 0;

#define TXNE (1U << 15)
#define BASY (1U << 14)

int main(void) {
    /* ... 写入数据到发区 */

    /* 是否被占用置1 */
    status_reg |= BASY;

    while (status &TXNE)
    /* 等待直至发送完成为空 */
        ;
    /* 是否被占用置0 */
    status &= ~(BASY);
}
```

如果你看不懂，不知道是怎么读取写入的，说明还是不够熟练，继续练习。

从x位到y位一般表示成`bit[y:x]`，y在x前面是因为低位在后面。而我们说从x到y一般是从低位到高位。而说从x到y个字节可以表示成`byte[x:y]`。

其实借助结构体位域也可以实现位操作，参照：[位域](/C/ComplexStruct#%E4%BD%8D%E5%9F%9F-bit-field)。但是位域不具有可移植性。如果你的代码在不同平台与不同编译器下编译，那么位域的大小和地址不一定是固定的。

# 取余与位运算

在编程中，我们常常会遇到取余数的运算。取余数就是指的一个数不能整除的情况下的余数，也叫取模，例如：`5 / 3 = 1 ... 2`，5除以3的余数是2。但是，如果取余的数是2的倍数，那么编译器会自动优化为位运算。你可能会感到迷惑，位运算与取余又有什么关系呢？我们先用十进制来看看：

随机给你一个数，例如1546156，这个数的10的余数一眼看出来就是6。如果求100的余数，我相信你也能看出来余数是56。那这是什么原理呢？我们擅长做10进制运算，如果是10的倍数，那么我们只需要**取后面几位数字**就可以了。

那么对于二进制数，如果求`0x234SAF2D`对于`0xF`的余数，计算机只需要取最后16位数字就可以。怎么取数字的？做与运算就可以了。CPU内部有非常多的逻辑运算单元（也就是与、或、非门电路），相比与算数运算，逻辑运算的速度非常快。因此，对2的倍数的取余运算，编译器会直接优化为按位与运算。